define("qtype_imageselect/image_editable",["exports","core/ajax","qtype_imageselect/cropper","core/str","core/templates","core/notification"],(function(_exports,_ajax,_cropper,_str,_templates,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * This file is part of Moodle - http://moodle.org/
   *
   * Moodle is free software: you can redistribute it and/or modify
   * it under the terms of the GNU General Public License as published by
   * the Free Software Foundation, either version 3 of the License, or
   * (at your option) any later version.
   *
   * Moodle is distributed in the hope that it will be useful,
   * but WITHOUT ANY WARRANTY; without even the implied warranty of
   * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   * GNU General Public License for more details.
   *
   * You should have received a copy of the GNU General Public License
   * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
   *
   * @copyright 2021 Bas Brands
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=_exports.humanFileSize=void 0,_ajax=_interopRequireDefault(_ajax),_cropper=_interopRequireDefault(_cropper),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var selectors_actions={confirm:'[data-action="confirm"]',cancel:'[data-action="cancel"]',cropimage:'[data-action="cropimage"]',rotateleft:'[data-action="rotateleft"]',rotateright:'[data-action="rotateright"]',uploadimage:'[data-action="uploadimage"]',deleteimage:'[data-action="deleteimage"]'},selectors_regions$0={imagehandler:'[data-region="imagehandler"]',imagecontrols:'[data-region="imagecontrols"]',alert:".alert",zoomslider:".cr-slider",editactions:'[data-region="editactions"]',confirmactions:'[data-region="confirmactions"]',spinner:'[data-region="spinner"]',hiddenFormField:'[data-region="hiddenformfield"]'},selectors_classes={hidden:"d-none",saving:"saving",deleting:"deleting",disabled:"disabled",enabled:"js-enabled"},humanFileSize=function(size){var i=Math.floor(Math.log(size)/Math.log(1024));return 1*(size/Math.pow(1024,i)).toFixed(2)+" "+["B","kB","MB","GB","TB"][i]};_exports.humanFileSize=humanFileSize;var showImageAlert=function(target,msg){return _templates.default.render("core/notification",{message:msg,closebutton:!0,iswarning:!0}).then((function(html,js){_templates.default.prependNodeContents(target,html,js)}))},showSpinner=function(target,show){var spinner=target.querySelector(selectors_regions$0.spinner);show?spinner.classList.remove(selectors_classes.hidden):spinner.classList.add(selectors_classes.hidden)},showDeleteOption=function(target,show){var deleteimage=target.querySelector(selectors_actions.deleteimage);show?(deleteimage.classList.add(selectors_classes.enabled),deleteimage.setAttribute("tabindex",0)):(deleteimage.classList.remove(selectors_classes.enabled),deleteimage.setAttribute("tabindex",-1))},showEditActions=function(target){var currentimage=target.getAttribute("data-currentimage"),cropimage=target.querySelector(selectors_actions.cropimage),confirmactions=target.querySelector(selectors_regions$0.confirmactions),editactions=target.querySelector(selectors_regions$0.editactions);currentimage?(cropimage.classList.remove(selectors_classes.hidden),showDeleteOption(target,!0)):(cropimage.classList.add(selectors_classes.hidden),showDeleteOption(target,!1)),confirmactions.classList.add(selectors_classes.hidden),editactions.classList.remove(selectors_classes.hidden),function(target){var alert=target.querySelector(selectors_regions$0.alert);alert&&alert.remove()}(target)},updateImage=function(args){var request={methodname:"qtype_imageselect_imageeditable_update_image",args:args};return _ajax.default.call([request])[0].fail(_notification.default.exception)},setBackgroundImage=function(imageHandler,imageUrl){imageHandler.style.backgroundImage='url("'+imageUrl+'")'},confirmAction=function(target,string,action){var confirmactions=target.querySelector(selectors_regions$0.confirmactions),editactions=target.querySelector(selectors_regions$0.editactions),confirm=target.querySelector(selectors_actions.confirm),newconfirm=confirm.cloneNode(!0);confirm.parentNode.replaceChild(newconfirm,confirm),string.done((function(str){newconfirm.innerHTML=str,confirmactions.classList.remove(selectors_classes.hidden),editactions.classList.add(selectors_classes.hidden),newconfirm.addEventListener("click",(function(e){action(),e.preventDefault()}))})),showDeleteOption(target,!1)},cancelAction=function(target,action){var cancel=target.querySelector(selectors_actions.cancel),newcancel=cancel.cloneNode(!0);cancel.parentNode.replaceChild(newcancel,cancel),newcancel.addEventListener("click",(function(e){action(),e.preventDefault()}))},imageRotator=function(target,angle){target.querySelector(selectors_regions$0.imagehandler),target.getAttribute("data-currentimage"),target.getAttribute("data-size");var image=document.getElementById("singleimage_id_imageitem_0");new _cropper.default(image,{aspectRatio:1,minCropBoxHeight:250,minCropBoxWidth:250,rotatable:!0}).rotate(angle)};_exports.init=function(target,siteMaxBytes){var cropimage=target.querySelector(selectors_actions.cropimage),rotateleft=target.querySelector(selectors_actions.rotateleft),rotateright=target.querySelector(selectors_actions.rotateright),uploadimage=target.querySelector(selectors_actions.uploadimage),deleteimage=target.querySelector(selectors_actions.deleteimage),imagecontrols=target.querySelector(selectors_regions$0.imagecontrols);cropimage.addEventListener("click",(function(e){!function(target){var imageHandler=target.querySelector(selectors_regions.imagehandler),currentImage=target.getAttribute("data-currentimage"),size=target.getAttribute("data-size"),croppedImage=new Croppie(imageHandler,{enableExif:!0,viewport:{width:size/100*90,height:size/100*90,type:"square"}});croppedImage.bind({url:currentImage}),setBackgroundImage(imageHandler,"");var zoomslider=target.querySelector(selectors_regions$0.zoomslider);zoomslider.classList.add("form-control-range"),zoomslider.setAttribute("step",.01),"rounded"===target.getAttribute("data-rounded")&&target.querySelector(".cr-viewport").classList.add("cr-vp-circle"),confirmAction(target,(0,_str.get_string)("cropimage","qtype_imageselect"),(function(){croppedImage.result("base64").then((function(imageData){var ajaxParams={imagedata:imageData.split("base64,")[1],imagefilename:"cropped.png",cropped:1,component:target.getAttribute("data-component"),filearea:target.getAttribute("data-filearea"),contextid:target.getAttribute("data-contextid"),draftitemid:target.getAttribute("data-draftitemid")};showSpinner(target,!0),updateImage({params:ajaxParams}).then((function(result){result.success&&(setBackgroundImage(imageHandler,imageData),croppedImage.destroy()),result.warning&&showImageAlert(imageHandler,result.warning),showSpinner(target,!1),showEditActions(target)})).catch(_notification.default.exception)})).catch(_notification.default.exception)})),cancelAction(target,(function(){croppedImage.destroy(),setBackgroundImage(imageHandler,currentImage),showEditActions(target)}))}(target),e.preventDefault()})),rotateleft.addEventListener("click",(function(e){imageRotator(target,-20),e.preventDefault()})),rotateright.addEventListener("click",(function(e){imageRotator(target,20),e.preventDefault()})),uploadimage.addEventListener("change",(function(e){!function(target,siteMaxBytes,event){var imageHandler=target.querySelector(selectors_regions$0.imagehandler),hiddenFormField=target.querySelector(selectors_regions$0.hiddenFormField),file=event.target.files[0];if(file.type.match("image.*")){var backupImage=target.getAttribute("data-currentimage");""===backupImage&&(backupImage=target.getAttribute("data-defaultimage"));var reader=new FileReader;reader.onload=function(){var filedata=reader.result;if(file.size>siteMaxBytes){var maxbytesstr={size:humanFileSize(siteMaxBytes),file:file.name};(0,_str.get_string)("maxbytesfile","error",maxbytesstr).done((function(message){showImageAlert(imageHandler,message)}))}else{var img=document.createElement("img");img.setAttribute("src",filedata),img.addEventListener("load",(function(){img.naturalWidth<512&&(0,_str.get_string)("resolutionlow","qtype_imageselect").done((function(message){showImageAlert(imageHandler,message)}))})),setBackgroundImage(imageHandler,filedata);var ajaxParams={imagefilename:file.name,imagedata:filedata.split("base64,")[1],cropped:0,component:target.getAttribute("data-component"),filearea:target.getAttribute("data-filearea"),contextid:target.getAttribute("data-contextid"),draftitemid:target.getAttribute("data-draftitemid")};confirmAction(target,(0,_str.get_string)("save","admin"),(function(){showSpinner(target,!0),updateImage({params:ajaxParams}).then((function(result){result.success&&(target.setAttribute("data-currentimage",result.fileurl),backupImage=result.fileurl),result.warning&&showImageAlert(imageHandler,result.warning),hiddenFormField&&(hiddenFormField.value=ajaxParams.draftitemid),showSpinner(target,!1),showEditActions(target)})).catch(_notification.default.exception)})),cancelAction(target,(function(){setBackgroundImage(imageHandler,backupImage),showEditActions(target)}))}},reader.readAsDataURL(file)}}(target,siteMaxBytes,e),e.preventDefault()})),deleteimage.addEventListener("click",(function(e){e.preventDefault()})),showEditActions(target),imagecontrols.classList.add("js-enabled")}}));

//# sourceMappingURL=image_editable.min.js.map