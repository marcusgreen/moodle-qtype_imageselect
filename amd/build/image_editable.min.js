define("qtype_imageselect/image_editable",["exports","core/ajax","qtype_imageselect/cropper","core/str","core/templates","core/notification"],(function(_exports,_ajax,_cropper,_str,_templates,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * This file is part of Moodle - http://moodle.org/
   *
   * Moodle is free software: you can redistribute it and/or modify
   * it under the terms of the GNU General Public License as published by
   * the Free Software Foundation, either version 3 of the License, or
   * (at your option) any later version.
   *
   * Moodle is distributed in the hope that it will be useful,
   * but WITHOUT ANY WARRANTY; without even the implied warranty of
   * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   * GNU General Public License for more details.
   *
   * You should have received a copy of the GNU General Public License
   * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
   *
   * @copyright 2021 Bas Brands
   * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=_exports.humanFileSize=void 0,_ajax=_interopRequireDefault(_ajax),_cropper=_interopRequireDefault(_cropper),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);const selectors_actions={confirm:'[data-action="confirm"]',cancel:'[data-action="cancel"]',cropimage:'[data-action="cropimage"]',rotateleft:'[data-action="rotateleft"]',rotateright:'[data-action="rotateright"]',uploadimage:'[data-action="uploadimage"]',deleteimage:'[data-action="deleteimage"]'},selectors_regions$0={imagehandler:'[data-region="imagehandler"]',imagecontrols:'[data-region="imagecontrols"]',alert:".alert",zoomslider:".cr-slider",editactions:'[data-region="editactions"]',confirmactions:'[data-region="confirmactions"]',spinner:'[data-region="spinner"]',hiddenFormField:'[data-region="hiddenformfield"]'},selectors_classes={hidden:"d-none",saving:"saving",deleting:"deleting",disabled:"disabled",enabled:"js-enabled"},humanFileSize=size=>{const i=Math.floor(Math.log(size)/Math.log(1024));return 1*(size/Math.pow(1024,i)).toFixed(2)+" "+["B","kB","MB","GB","TB"][i]};_exports.humanFileSize=humanFileSize;const showImageAlert=(target,msg)=>_templates.default.render("core/notification",{message:msg,closebutton:!0,iswarning:!0}).then(((html,js)=>{_templates.default.prependNodeContents(target,html,js)})),showSpinner=(target,show)=>{const spinner=target.querySelector(selectors_regions$0.spinner);show?spinner.classList.remove(selectors_classes.hidden):spinner.classList.add(selectors_classes.hidden)},showDeleteOption=(target,show)=>{const deleteimage=target.querySelector(selectors_actions.deleteimage);show?(deleteimage.classList.add(selectors_classes.enabled),deleteimage.setAttribute("tabindex",0)):(deleteimage.classList.remove(selectors_classes.enabled),deleteimage.setAttribute("tabindex",-1))},showEditActions=target=>{const currentimage=target.getAttribute("data-currentimage"),cropimage=target.querySelector(selectors_actions.cropimage),confirmactions=target.querySelector(selectors_regions$0.confirmactions),editactions=target.querySelector(selectors_regions$0.editactions);currentimage?(cropimage.classList.remove(selectors_classes.hidden),showDeleteOption(target,!0)):(cropimage.classList.add(selectors_classes.hidden),showDeleteOption(target,!1)),confirmactions.classList.add(selectors_classes.hidden),editactions.classList.remove(selectors_classes.hidden),(target=>{const alert=target.querySelector(selectors_regions$0.alert);alert&&alert.remove()})(target)},updateImage=args=>{const request={methodname:"qtype_imageselect_imageeditable_update_image",args:args};return _ajax.default.call([request])[0].fail(_notification.default.exception)},setBackgroundImage=(imageHandler,imageUrl)=>{imageHandler.style.backgroundImage='url("'+imageUrl+'")'},confirmAction=(target,string,action)=>{const confirmactions=target.querySelector(selectors_regions$0.confirmactions),editactions=target.querySelector(selectors_regions$0.editactions),confirm=target.querySelector(selectors_actions.confirm),newconfirm=confirm.cloneNode(!0);confirm.parentNode.replaceChild(newconfirm,confirm),string.done((str=>{newconfirm.innerHTML=str,confirmactions.classList.remove(selectors_classes.hidden),editactions.classList.add(selectors_classes.hidden),newconfirm.addEventListener("click",(e=>{action(),e.preventDefault()}))})),showDeleteOption(target,!1)},cancelAction=(target,action)=>{let cancel=target.querySelector(selectors_actions.cancel);const newcancel=cancel.cloneNode(!0);cancel.parentNode.replaceChild(newcancel,cancel),newcancel.addEventListener("click",(e=>{action(),e.preventDefault()}))};_exports.init=(target,siteMaxBytes)=>{const cropimage=target.querySelector(selectors_actions.cropimage),rotateleft=target.querySelector(selectors_actions.rotateleft),rotateright=target.querySelector(selectors_actions.rotateright),uploadimage=target.querySelector(selectors_actions.uploadimage),deleteimage=target.querySelector(selectors_actions.deleteimage),imagecontrols=target.querySelector(selectors_regions$0.imagecontrols);var image=document.getElementById("singleimage_id_imageitem_0"),cropper=new _cropper.default(image,{autoCrop:!0,zoomable:!1,viewMode:2});cropimage.addEventListener("click",(e=>{var canvas=cropper.getCroppedCanvas();cropper.replace(canvas.toDataURL(),!0),cropper.clear(),e.preventDefault()})),rotateleft.addEventListener("click",(e=>{cropper.rotate(-45),e.preventDefault()})),rotateright.addEventListener("click",(e=>{cropper.rotate(90),e.preventDefault()})),uploadimage.addEventListener("change",(e=>{((target,siteMaxBytes,event)=>{const imageHandler=target.querySelector(selectors_regions$0.imagehandler),hiddenFormField=target.querySelector(selectors_regions$0.hiddenFormField);let file=event.target.files[0];if(!file.type.match("image.*"))return;let backupImage=target.getAttribute("data-currentimage");""===backupImage&&(backupImage=target.getAttribute("data-defaultimage"));var reader=new FileReader;reader.onload=()=>{let filedata=reader.result;if(file.size>siteMaxBytes){const maxbytesstr={size:humanFileSize(siteMaxBytes),file:file.name};return void(0,_str.get_string)("maxbytesfile","error",maxbytesstr).done((message=>{showImageAlert(imageHandler,message)}))}let img=document.createElement("img");img.setAttribute("src",filedata),img.addEventListener("load",(()=>{img.naturalWidth<512&&(0,_str.get_string)("resolutionlow","qtype_imageselect").done((message=>{showImageAlert(imageHandler,message)}))})),setBackgroundImage(imageHandler,filedata);let ajaxParams={imagefilename:file.name,imagedata:filedata.split("base64,")[1],cropped:0,component:target.getAttribute("data-component"),filearea:target.getAttribute("data-filearea"),contextid:target.getAttribute("data-contextid"),draftitemid:target.getAttribute("data-draftitemid")};confirmAction(target,(0,_str.get_string)("save","admin"),(()=>{showSpinner(target,!0),updateImage({params:ajaxParams}).then((result=>{result.success&&(target.setAttribute("data-currentimage",result.fileurl),backupImage=result.fileurl),result.warning&&showImageAlert(imageHandler,result.warning),hiddenFormField&&(hiddenFormField.value=ajaxParams.draftitemid),showSpinner(target,!1),showEditActions(target)})).catch(_notification.default.exception)})),cancelAction(target,(()=>{setBackgroundImage(imageHandler,backupImage),showEditActions(target)}))},reader.readAsDataURL(file)})(target,siteMaxBytes,e),e.preventDefault()})),deleteimage.addEventListener("click",(e=>{e.preventDefault()})),showEditActions(target),imagecontrols.classList.add("js-enabled")}}));

//# sourceMappingURL=image_editable.min.js.map