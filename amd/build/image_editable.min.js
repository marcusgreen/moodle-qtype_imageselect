define ("qtype_imageselect/image_editable",["exports","core/ajax","qtype_imageselect/croppie","core/str","core/templates","core/notification"],function(a,b,c,d,e,f){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=a.humanFileSize=void 0;b=g(b);c=g(c);e=g(e);f=g(f);function g(a){return a&&a.__esModule?a:{default:a}}var h={actions:{confirm:"[data-action=\"confirm\"]",cancel:"[data-action=\"cancel\"]",cropimage:"[data-action=\"cropimage\"]",rotateleft:"[data-action=\"rotateleft\"]",rotateright:"[data-action=\"rotateright\"]",uploadimage:"[data-action=\"uploadimage\"]",deleteimage:"[data-action=\"deleteimage\"]"},regions:{imagehandler:"[data-region=\"imagehandler\"]",imagecontrols:"[data-region=\"imagecontrols\"]",alert:".alert",zoomslider:".cr-slider",editactions:"[data-region=\"editactions\"]",confirmactions:"[data-region=\"confirmactions\"]",spinner:"[data-region=\"spinner\"]",hiddenFormField:"[data-region=\"hiddenformfield\"]"},classes:{hidden:"d-none",saving:"saving",deleting:"deleting",disabled:"disabled",enabled:"js-enabled"}},i=function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,b)).toFixed(2)+" "+["B","kB","MB","GB","TB"][b]};a.humanFileSize=i;var j=function(a,b){return e.default.render("core/notification",{message:b,closebutton:!0,iswarning:!0}).then(function(b,c){e.default.prependNodeContents(a,b,c)})},k=function(a){var b=a.querySelector(h.regions.alert);if(b){b.remove()}},l=function(a,b){var c=a.querySelector(h.regions.spinner);if(b){c.classList.remove(h.classes.hidden)}else{c.classList.add(h.classes.hidden)}},m=function(a,b){var c=a.querySelector(h.actions.deleteimage);if(b){c.classList.add(h.classes.enabled);c.setAttribute("tabindex",0)}else{c.classList.remove(h.classes.enabled);c.setAttribute("tabindex",-1)}},n=function(a){var b=a.getAttribute("data-currentimage"),c=a.querySelector(h.actions.cropimage),d=a.querySelector(h.regions.confirmactions),e=a.querySelector(h.regions.editactions);if(b){c.classList.remove(h.classes.hidden);m(a,!0)}else{c.classList.add(h.classes.hidden);m(a,!1)}d.classList.add(h.classes.hidden);e.classList.remove(h.classes.hidden);k(a)},o=function(a){var c=b.default.call([{methodname:"qtype_imageselect_imageeditable_update_image",args:a}])[0].fail(f.default.exception);return c},p=function(a,b){a.style.backgroundImage="url(\""+b+"\")"},q=function(a,b,c){var d=a.querySelector(h.regions.confirmactions),e=a.querySelector(h.regions.editactions),f=a.querySelector(h.actions.confirm),g=f.cloneNode(!0);f.parentNode.replaceChild(g,f);b.done(function(a){g.innerHTML=a;d.classList.remove(h.classes.hidden);e.classList.add(h.classes.hidden);g.addEventListener("click",function(a){c();a.preventDefault()})});m(a,!1)},r=function(a,b){var c=a.querySelector(h.actions.cancel),d=c.cloneNode(!0);c.parentNode.replaceChild(d,c);d.addEventListener("click",function(a){b();a.preventDefault()})},s=function(a){var b=a.querySelector(h.regions.imagehandler),e=a.getAttribute("data-currentimage"),g=a.getAttribute("data-size"),i=new c.default(b,{enableExif:!0,viewport:{width:90*(g/100),height:90*(g/100),type:"square"}});i.bind({url:e});p(b,"");var k=a.querySelector(h.regions.zoomslider);k.classList.add("form-control-range");k.setAttribute("step",.01);if("rounded"===a.getAttribute("data-rounded")){a.querySelector(".cr-viewport").classList.add("cr-vp-circle")}q(a,(0,d.get_string)("cropimage","qtype_imageselect"),function(){i.result("base64").then(function(c){var d={imagedata:c.split("base64,")[1],imagefilename:"cropped.png",cropped:1,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid")};l(a,!0);o({params:d}).then(function(d){if(d.success){p(b,c);i.destroy()}if(d.warning){j(b,d.warning,"warning")}l(a,!1);n(a)}).catch(f.default.exception)}).catch(f.default.exception)});r(a,function(){i.destroy();p(b,e);n(a)})},t=function(a,b){var e=a.querySelector(h.regions.imagehandler),g=a.getAttribute("data-currentimage"),i=a.getAttribute("data-size"),k=new c.default(e,{enableExif:!0,viewport:{width:100*(i/100),height:100*(i/100),boundary:{width:300,height:300},type:"square"},enableOrientation:!0,showZoomer:!1});k.bind({url:g,orientation:b});p(e,"");q(a,(0,d.get_string)("confirm","qtype_imageselect"),function(){k.result("base64").then(function(b){var c={imagedata:b.split("base64,")[1],imagefilename:"rotated.png",cropped:1,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid")};l(a,!0);o({params:c}).then(function(c){if(c.success){p(e,b);k.destroy()}if(c.warning){j(e,c.warning,"warning")}l(a,!1);n(a)}).catch(f.default.exception)}).catch(f.default.exception)});r(a,function(){k.destroy();p(e,g);n(a)})},u=function(a,b,c){var e=a.querySelector(h.regions.imagehandler),g=a.querySelector(h.regions.hiddenFormField),k=c.target.files[0];if(!k.type.match("image.*")){return}var m=a.getAttribute("data-currentimage");if(""===m){m=a.getAttribute("data-defaultimage")}var s=new FileReader;s.onload=function(){var c=s.result;if(k.size>b){var u={size:i(b),file:k.name};(0,d.get_string)("maxbytesfile","error",u).done(function(a){j(e,a)});return}var h=document.createElement("img");h.setAttribute("src",c);h.addEventListener("load",function(){if(512>h.naturalWidth){(0,d.get_string)("resolutionlow","qtype_imageselect").done(function(a){j(e,a)})}});p(e,c);var t={imagefilename:k.name,imagedata:c.split("base64,")[1],cropped:0,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid")};q(a,(0,d.get_string)("save","admin"),function(){l(a,!0);o({params:t}).then(function(b){if(b.success){a.setAttribute("data-currentimage",b.fileurl);m=b.fileurl}if(b.warning){j(e,b.warning,"warning")}if(g){g.value=t.draftitemid}l(a,!1);n(a)}).catch(f.default.exception)});r(a,function(){p(e,m);n(a)})};s.readAsDataURL(k)},v=function(a){var b=a.querySelector(h.actions.deleteimage),c=a.querySelector(h.regions.hiddenFormField);if(!b.classList.contains(h.classes.enabled)){return""}var e=a.getAttribute("data-defaultimage"),g=a.querySelector(h.regions.imagehandler),i={imagedata:"",imagefilename:"",cropped:0,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid"),delete:1};q(a,(0,d.get_string)("delete","moodle"),function(){l(a,!0);o({params:i}).then(function(b){if(b.success){p(g,e);a.setAttribute("data-currentimage","")}if(c){c.value=-2}l(a,!1);n(a);return""}).catch(f.default.exception)});r(a,function(){n(a)});return""};a.init=function init(a,b){var c=a.querySelector(h.actions.cropimage),d=a.querySelector(h.actions.rotateleft),e=a.querySelector(h.actions.rotateright),f=a.querySelector(h.actions.uploadimage),g=a.querySelector(h.actions.deleteimage),i=a.querySelector(h.regions.imagecontrols);c.addEventListener("click",function(b){s(a);b.preventDefault()});d.addEventListener("click",function(b){t(a,8);b.preventDefault()});e.addEventListener("click",function(b){t(a,6);b.preventDefault()});f.addEventListener("change",function(c){u(a,b,c);c.preventDefault()});g.addEventListener("click",function(b){v(a);b.preventDefault()});n(a);i.classList.add("js-enabled")}});
//# sourceMappingURL=image_editable.min.js.map
